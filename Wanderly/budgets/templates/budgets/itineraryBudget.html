{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Budget Planner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'styles.css' %}">
  <link rel="stylesheet" href="{% static 'navbar.css' %}">
  <link rel="stylesheet" href="{% static 'budgets/styles.css' %}">
</head>
<body class="bg-light budget-itinerary" data-budget-other-value="{{ budget_other_value }}">
  <nav>
    {% include "navbar.html" %}
  </nav>

  <header class="info-section">
    <div class="container py-5">
      <div class="row align-items-center g-5">
        <div class="col-lg-8">
          <h1 class="display-5 fw-bold mb-3">Budget Planner</h1>
          <p class="lead mb-0">
            Organize your travel spending by adding categories and defining amounts that fit your trip.
          </p>
        </div>
      </div>
    </div>
  </header>

  <section class="container py-4">
    <form method="post" class="card shadow-sm rounded-xxl gradient-card p-4 p-md-5">
      {% csrf_token %}
      {{ formset.management_form }}

      {% if formset.non_form_errors %}
        <div class="alert alert-danger">{{ formset.non_form_errors|join:", " }}</div>
      {% endif %}

      <div id="budgetItems">
        {% for form in formset %}
          <div class="budget-item" data-form-index="{{ forloop.counter0 }}">
            {% for hidden in form.hidden_fields %}
              {{ hidden }}
            {% endfor %}
            {% if form.non_field_errors %}
              <div class="alert alert-danger small mb-3">
                {{ form.non_field_errors|join:" " }}
              </div>
            {% endif %}

            <div class="row g-3">
              <div class="col-12 col-lg-6">
                <label class="form-label text-uppercase small text-muted mb-1 d-flex justify-content-between align-items-center" for="{{ form.category.id_for_label }}">
                  <span>Budget Category</span>
                  <button type="button" class="btn btn-outline-danger btn-sm remove-budget-item d-none">Remove</button>
                </label>
                <select
                  class="form-select budget-category{% if form.category.errors %} is-invalid{% endif %}"
                  id="{{ form.category.id_for_label }}"
                  name="{{ form.category.html_name }}"
                  required
                >
                  {% for value, label in form.fields.category.choices %}
                    <option value="{{ value }}"{% if value|stringformat:'s' == form.category.value|stringformat:'s' %} selected{% endif %}>
                      {{ label }}
                    </option>
                  {% endfor %}
                </select>
                {% if form.category.errors %}
                  <div class="invalid-feedback d-block small">
                    {% for error in form.category.errors %}
                      {{ error }}{% if not forloop.last %}<br>{% endif %}
                    {% endfor %}
                  </div>
                {% endif %}
              </div>

              <div class="col-12 col-lg-6 custom-category-group{% if form.category.value != budget_other_value %} d-none{% endif %}">
                <label class="form-label text-uppercase small text-muted mb-1" for="{{ form.custom_category.id_for_label }}">
                  Custom Category
                </label>
                <input
                  type="text"
                  class="form-control custom-category{% if form.custom_category.errors %} is-invalid{% endif %}"
                  id="{{ form.custom_category.id_for_label }}"
                  name="{{ form.custom_category.html_name }}"
                  value="{{ form.custom_category.value|default_if_none:'' }}"
                  placeholder="Enter category name"
                  {% if form.category.value == budget_other_value %}required{% endif %}
                >
                {% if form.custom_category.errors %}
                  <div class="invalid-feedback d-block small">
                    {% for error in form.custom_category.errors %}
                      {{ error }}{% if not forloop.last %}<br>{% endif %}
                    {% endfor %}
                  </div>
                {% endif %}
              </div>
            </div>

            <div class="row g-3 align-items-end mt-2 budget-amount-row">
              <div class="col-12 col-md-6 col-lg-4">
                <label class="form-label" for="{{ form.amount.id_for_label }}">Budget Amount</label>
                <div class="input-group">
                  <span class="input-group-text">$</span>
                  <input
                    type="number"
                    class="form-control budget-amount{% if form.amount.errors %} is-invalid{% endif %}"
                    id="{{ form.amount.id_for_label }}"
                    name="{{ form.amount.html_name }}"
                    value="{{ form.amount.value|default_if_none:'' }}"
                    min="0"
                    step="0.01"
                    placeholder="Amount"
                    required
                  >
                </div>
                {% if form.amount.errors %}
                  <div class="invalid-feedback d-block small">
                    {% for error in form.amount.errors %}
                      {{ error }}{% if not forloop.last %}<br>{% endif %}
                    {% endfor %}
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
        {% endfor %}
      </div>

      <div class="d-flex flex-wrap gap-2 mt-3">
        <button type="button" id="addBudgetItem" class="add-budget-btn">
          + Add Budget Item
        </button>
        <button type="submit" class="btn btn-primary">
          Save Budget Plan
        </button>
      </div>
    </form>
  </section>

  <template id="budgetItemTemplate">
    {% with form=formset.empty_form %}
      <div class="budget-item" data-form-index="__prefix__">
        {% for hidden in form.hidden_fields %}
          {{ hidden }}
        {% endfor %}
        <div class="row g-3">
          <div class="col-12 col-lg-6">
            <label class="form-label text-uppercase small text-muted mb-1 d-flex justify-content-between align-items-center" for="{{ form.category.id_for_label }}">
              <span>Budget Category</span>
              <button type="button" class="btn btn-outline-danger btn-sm remove-budget-item d-none">Remove</button>
            </label>
            <select
              class="form-select budget-category"
              id="{{ form.category.id_for_label }}"
              name="{{ form.category.html_name }}"
              required
            >
              {% for value, label in form.fields.category.choices %}
                <option value="{{ value }}">{{ label }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-12 col-lg-6 custom-category-group d-none">
            <label class="form-label text-uppercase small text-muted mb-1" for="{{ form.custom_category.id_for_label }}">
              Custom Category
            </label>
            <input
              type="text"
              class="form-control custom-category"
              id="{{ form.custom_category.id_for_label }}"
              name="{{ form.custom_category.html_name }}"
              value=""
              placeholder="Enter category name"
            >
          </div>
        </div>

        <div class="row g-3 align-items-end mt-2 budget-amount-row">
          <div class="col-12 col-md-6 col-lg-4">
            <label class="form-label" for="{{ form.amount.id_for_label }}">Budget Amount</label>
            <div class="input-group">
              <span class="input-group-text">$</span>
              <input
                type="number"
                class="form-control budget-amount"
                id="{{ form.amount.id_for_label }}"
                name="{{ form.amount.html_name }}"
                value=""
                min="0"
                step="0.01"
                placeholder="Amount"
                required
              >
            </div>
          </div>
        </div>
      </div>
    {% endwith %}
  </template>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Bootstrap-inspired planner logic wrapped to avoid leaking globals
    (function () {
      // Cached project-wide constants + DOM references used throughout the module
      const otherValue = document.body.dataset.budgetOtherValue || "";
      const container = document.getElementById("budgetItems");       // Holds every budget block
      const template = document.getElementById("budgetItemTemplate"); // Empty form prototype
      const addButton = document.getElementById("addBudgetItem");     // "Add Budget Item" control
      const totalFormsInput = document.querySelector("#id_items-TOTAL_FORMS"); // Mgmt form count

      if (!container || !template || !addButton || !totalFormsInput) {
        // Bail early if any of the required DOM pieces are missing
        return;
      }

      const templateHtml = template.innerHTML.trim(); // Slight perf boost vs reading every time

      // Helper to update the amount placeholder using the most meaningful label we have
      function setAmountPlaceholder(amountInput, label) {
        if (amountInput) {
          const trimmed = label ? label.trim() : "";
          amountInput.placeholder = trimmed ? `Amount for ${trimmed}` : "Amount";
        }
      }

      // Keeps the management form count aligned with the number of DOM items
      function updateFormCount() {
        totalFormsInput.value = container.querySelectorAll(".budget-item").length;
      }

      // Re-index every form field/id/label so Django formsets bind correctly after add/remove
      function renumberForms() {
        container.querySelectorAll(".budget-item").forEach((item, index) => {
          item.dataset.formIndex = index; // Useful for debugging + future hooks

          item.querySelectorAll("[name]").forEach((field) => {
            // Swap the existing form index with the new one (e.g. items-0-category -> items-1-category)
            field.name = field.name.replace(/items-\d+-/, `items-${index}-`);
          });

          item.querySelectorAll("[id]").forEach((field) => {
            // Keep IDs in sync so label "for" attributes still point at the right element
            field.id = field.id.replace(/items-\d+-/, `items-${index}-`);
          });

          item.querySelectorAll("label[for]").forEach((label) => {
            label.htmlFor = label.htmlFor.replace(/items-\d+-/, `items-${index}-`);
          });
        });
      }

      // Show or hide the per-item remove button depending on how many blocks exist
      function toggleRemoveButtons() {
        const items = container.querySelectorAll(".budget-item");
        const showRemove = items.length > 1;

        items.forEach((item) => {
          const removeButton = item.querySelector(".remove-budget-item");
          if (!removeButton) {
            return;
          }
          if (showRemove) {
            removeButton.classList.remove("d-none"); // Show when more than one item exists
            removeButton.disabled = false; // Ensure keyboard focus works
          } else {
            removeButton.classList.add("d-none"); // Hide/disable when only one item remains
            removeButton.disabled = true;
          }
        });
      }

      // Apply dynamic behaviour to a single budget item block
      function setupBudgetItem(item) {
        const select = item.querySelector(".budget-category");
        const customGroup = item.querySelector(".custom-category-group");
        const customInput = item.querySelector(".custom-category");
        const amountInput = item.querySelector(".budget-amount");
        const removeButton = item.querySelector(".remove-budget-item");

        // When the user picks a category, update the amount placeholder or reveal the custom name input
        function updateFromSelect() {
          const selectedOption = select?.options[select.selectedIndex];

          if (!selectedOption || !selectedOption.value) {
            setAmountPlaceholder(amountInput, "");
            customGroup?.classList.add("d-none"); // Hide custom input when no primary category
            if (customInput) {
              customInput.required = false; // Reset required flag so validation passes
              customInput.value = ""; // Drop any stray text from prior selections
            }
            return;
          }

          const baseLabel = selectedOption.textContent.trim() || "Budget";
          setAmountPlaceholder(amountInput, baseLabel);

          if (selectedOption.value === otherValue) {
            customGroup?.classList.remove("d-none"); // Reveal custom category text field
            if (customInput) {
              customInput.required = true; // Force user to fill in a name for "Other"
              const customLabel = customInput.value.trim() || "Other";
              setAmountPlaceholder(amountInput, customLabel); // Sync placeholder
            }
          } else {
            customGroup?.classList.add("d-none"); // Hide custom input for non-"Other" choices
            if (customInput) {
              customInput.required = false; // Remove required to avoid browser validation errors
              customInput.value = ""; // Clear leftover custom text
            }
          }
        }

        // Mirror custom category text into the amount placeholder
        function handleCustomInput() {
          const customLabel = customInput.value.trim() || "Other";
          setAmountPlaceholder(amountInput, customLabel);
        }

        select?.addEventListener("change", updateFromSelect);
        customInput?.addEventListener("input", handleCustomInput);

        removeButton?.addEventListener("click", () => {
          const existingItems = container.querySelectorAll(".budget-item");
          if (existingItems.length <= 1) {
            // Never allow deleting the final item; just bail silently
            return;
          }

          item.remove(); // Drop the DOM node entirely
          renumberForms(); // Re-stamp indices so Django can parse the POST
          updateFormCount(); // Sync management form count
          toggleRemoveButtons(); // Re-run visibility logic for the remaining items
        });

        updateFromSelect(); // Prime the UI based on any server-provided initial data
      }

      // Create a new formset row using the empty form template rendered by Django
      function addBudgetItem() {
        const index = parseInt(totalFormsInput.value, 10);
        const wrapper = document.createElement("div");
        wrapper.innerHTML = templateHtml.replace(/__prefix__/g, index); // Swap __prefix__ placeholder
        const newItem = wrapper.firstElementChild; // Actual budget item card we care about

        if (!newItem) {
          // If template rendering failed, exit gracefully
          return;
        }

        container.appendChild(newItem); // Insert into the DOM so query selectors can find it
        renumberForms(); // Bump every existing item to its new index position
        updateFormCount(); // Notify the management form of the new total
        setupBudgetItem(newItem); // Attach listeners + initial UI state to the new block
        toggleRemoveButtons(); // Ensure remove buttons show now that a second item exists
      }

      container.querySelectorAll(".budget-item").forEach(setupBudgetItem); // Hydrate existing rows
      // Initial sync so the management form reflects whatever came from the server
      renumberForms();
      updateFormCount();
      toggleRemoveButtons();
      addButton.addEventListener("click", addBudgetItem); // Wire up click-to-add behaviour
    })();
  </script>
</body>
</html>
