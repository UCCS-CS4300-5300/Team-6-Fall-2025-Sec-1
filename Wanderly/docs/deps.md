# Dependency Management (pip-tools)
Going to start managing dependencies using pip-tools with the "intent -> lock" pattern:
* `requirements.in` - we edit this one, add in top-level dependencies that need to be added for production. (Runtime dependencies)
* `requirements.txt` - auto-generated, fully pinned lock file with hashes to validate deps. 
* `dev-requirements.in` - includes `requirements.in` + dev/CI tools (CI has been edited to utilize this to install all tools).
* `dev-requirements.txt` - auto-generated lock file for dev/CI environments. 

* [One-Time setup](#1-one-time-setup)
* [File Layout Explained](#2-file-layout-explained)
* [Typical Workflow](#3-typical-workflow)
* [Adding A Production Dependency](#32-adding-a-production-dependency)
* [Adding A Dev/CI Tool](#33-adding-a-devci-tool)
* [Upgrading Packages](#34-upgrading-packages)
* [Removing A Package](#35-removing-a-package)

## 1) One-Time setup 
```
# Create a fresh venv
python3 -m venv .venv
# Activate
source .venv/bin/activate

# Install the dev lock file (runtime + tools)
pip install -r dev-requirements.txt

# Get exact sync of dev-requirements.txt (remove stray packages) using pip-tools
pip-sync dev-requirements.txt
```

## 2) File Layout Explained
```
requirements.in          # app runtime deps (your choices, with ~= ranges)
requirements.txt         # compiled lock for production (autogenerated)

dev-requirements.in      # -r requirements.in + dev tools (pytest, linters, etc.)
dev-requirements.txt     # compiled lock for dev/CI (autogenerated)
```

## 3) Typical Workflow
### 3.1) Installing Dependencies, see [One-Time Setup](#1-one-time-setup)

### 3.2) Adding a Production Dependency
```
# 1) Edit the requirements.in: append your package
#    using ~= for version pinning (~= signifies a compatible release version specifier)
# 2) Recompile the prod lock file to include this new package:
pip-compile --generate-hashes requirements.in
# 3) Recompile the dev lock file to include this new package
pip-compile --generate-hashes dev-requirements.in -o dev-requirements.txt
# 4) apply locally:
pip-sync dev-requirements.txt
# 5) Make sure to commit requirements.in, requirements.txt, dev-requirements.in, dev-requirements.txt
```
Always commit both `.in` and `.txt` files after recompiling. The `.txt` files are what CI and Render use to install dependencies deterministically.

### 3.3) Adding a Dev/CI Tool
```
# 1) Edit dev-requirements.in with new dependency (do not put dev tools in requirements.in)
# 2) Recompile dev lock:
pip-compile --generate-hashes dev-requirements.in -o dev-requirements.txt
# 3) sync up our local environment with new tool
pip-sync dev-requirements.txt
# 4) Commit dev-requirements.in and dev-requirements.txt
```

### 3.4) Upgrading Packages
```
pip-compile -U --generate-hashes requirements.in
pip-compile -U --generate-hashes dev-requirements.in -o dev-requirements.txt
pip-sync dev-requirements.txt
```

### 3.5) Removing a Package
```
# 1) Delete the line from the requirements file (can be requirements.in or dev-requirements.in depending on what it is)
# 2) Re-compile locks (same as above)
# 3) apply the update locally:
pip-sync dev-requirements.txt
```