{% load static %}
<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Wanderly Itinerary Creation</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <!-- bootstrap -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

        <link rel="stylesheet" href="{% static 'navbar.css' %}">
        
    </head>

    <body>
        {% include "navbar.html" %}
        <div class="container my-5">
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <h2 class="mb-4">Create Your Itinerary</h2>
                    <form method="post" novalidate>
                        {% csrf_token %}
                        
                        <!-- Destination Section -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0"> Destination</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label fw-semibold" for="id_destination">Where are you traveling to?</label>
                                    <input
                                        type="text"
                                        id="id_destination"
                                        name="destination"
                                        class="form-control js-places"
                                        placeholder="Enter a city or location..."
                                        data-places="1"
                                        data-types="geocode"
                                        data-country="us"
                                        data-place-id-target="#id_place_id"
                                        data-lat-target="#id_lat"
                                        data-lng-target="#id_lng"
                                        required
                                    />
                                    <input type="hidden" id="id_place_id" name="place_id">
                                    <input type="hidden" id="id_lat" name="lat">
                                    <input type="hidden" id="id_lng" name="lng">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Time Preferences Section -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">Time Preferences</h5>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="wake_up_time" class="form-label">Wake Up Time</label>
                                        <input type="time" class="form-control" id="wake_up_time" name="wake_up_time" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="bed_time" class="form-label">Bed Time</label>
                                        <input type="time" class="form-control" id="bed_time" name="bed_time" required>
                                    </div>
                                </div>
                                
                                <!-- Break Times (Optional) -->
                                <div class="mb-3">
                                    <label class="form-label">Additional Break Times (Optional)</label>
                                    <div id="break-times-container">
                                        <div class="row mb-2 break-time-row">
                                            <div class="col-md-5">
                                                <input type="time" class="form-control" name="break_start_time[]" placeholder="Start Time">
                                            </div>
                                            <div class="col-md-5">
                                                <input type="time" class="form-control" name="break_end_time[]" placeholder="End Time">
                                            </div>
                                            <div class="col-md-2">
                                                <button type="button" class="btn btn-outline-danger remove-break-btn" style="display: none;">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-outline-primary btn-sm mt-2" id="add-break-btn">
                                        <i class="bi bi-plus-circle"></i> Add Break Time
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Budget Planning Section -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">Budget Planning</h5>
                            </div>
                            <div class="card-body">
                                <div id="budget-items-container">
                                </div>
                                
                                <button type="button" class="btn add-budget-btn w-100" id="add-budget-item-btn">
                                    <i class="bi bi-plus-circle"></i> Add Budget Item
                                </button>
                                
                                <div class="text-center mt-4">
                                    <button type="button" class="btn save-budget-btn">
                                        Save Budget Plan
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Days Section -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="bi bi-calendar-check"></i> Days</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="num_days" class="form-label">How many days is your trip?</label>
                                    <input type="number" class="form-control" id="num_days" name="num_days" min="1" max="30" value="1" required>
                                </div>
                                
                                <div id="days-container">
                                    <!-- Day cards will be generated here -->
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary btn-lg">Create Itinerary</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Bootstrap JS -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
        
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                // Break Times functionality
                const breakContainer = document.getElementById('break-times-container');
                const addBreakBtn = document.getElementById('add-break-btn');
                
                function updateRemoveButtons() {
                    const rows = breakContainer.querySelectorAll('.break-time-row');
                    rows.forEach((row, index) => {
                        const removeBtn = row.querySelector('.remove-break-btn');
                        if (rows.length > 1) {
                            removeBtn.style.display = 'inline-block';
                        } else {
                            removeBtn.style.display = 'none';
                        }
                    });
                }
                
                addBreakBtn.addEventListener('click', function() {
                    const newRow = document.createElement('div');
                    newRow.className = 'row mb-2 break-time-row';
                    newRow.innerHTML = `
                        <div class="col-md-5">
                            <input type="time" class="form-control" name="break_start_time[]" placeholder="Start Time">
                        </div>
                        <div class="col-md-5">
                            <input type="time" class="form-control" name="break_end_time[]" placeholder="End Time">
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-outline-danger remove-break-btn">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    `;
                    breakContainer.appendChild(newRow);
                    updateRemoveButtons();
                });
                
                breakContainer.addEventListener('click', function(e) {
                    if (e.target.closest('.remove-break-btn')) {
                        const row = e.target.closest('.break-time-row');
                        row.remove();
                        updateRemoveButtons();
                    }
                });
                
                updateRemoveButtons();

                // Budget Items functionality
                const budgetContainer = document.getElementById('budget-items-container');
                const addBudgetBtn = document.getElementById('add-budget-item-btn');
                
                const budgetCategories = [
                    'Accommodation',
                    'Transportation',
                    'Food & Dining',
                    'Activities',
                    'Shopping',
                    'Other'
                ];
                
                function createBudgetItem() {
                    const budgetItem = document.createElement('div');
                    budgetItem.className = 'budget-item-card';
                    budgetItem.innerHTML = `
                        <div class="row g-3 align-items-end">
                            <div class="col-md-5">
                                <label class="form-label text-white fw-bold">BUDGET CATEGORY</label>
                                <select class="form-select budget-category-select" name="budget_category[]">
                                    ${budgetCategories.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                                </select>
                            </div>
                            <div class="col-md-5">
                                <label class="form-label text-white fw-bold">CUSTOM CATEGORY</label>
                                <input type="text" class="form-control custom-category-input" name="budget_custom_category[]" placeholder="Enter category name">
                            </div>
                            <div class="col-md-2 text-end">
                                <button type="button" class="btn btn-outline-light remove-budget-btn">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                            <div class="col-12">
                                <label class="form-label text-white fw-bold">Budget Amount</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" name="budget_amount[]" placeholder="0" min="0" step="0.01">
                                </div>
                            </div>
                        </div>
                    `;
                    
                    budgetContainer.appendChild(budgetItem);
                    
                    // Toggle custom category visibility
                    const categorySelect = budgetItem.querySelector('.budget-category-select');
                    const customCategoryInput = budgetItem.querySelector('.custom-category-input');
                    
                    function toggleCustomCategory() {
                        if (categorySelect.value === 'Other') {
                            customCategoryInput.style.display = 'block';
                            customCategoryInput.required = true;
                        } else {
                            customCategoryInput.style.display = 'none';
                            customCategoryInput.required = false;
                            customCategoryInput.value = '';
                        }
                    }
                    
                    categorySelect.addEventListener('change', toggleCustomCategory);
                    toggleCustomCategory();
                }
                
                addBudgetBtn.addEventListener('click', createBudgetItem);
                
                // Remove budget item
                budgetContainer.addEventListener('click', function(e) {
                    if (e.target.closest('.remove-budget-btn')) {
                        const item = e.target.closest('.budget-item-card');
                        item.remove();
                    }
                });

                // Days functionality
                const numDaysInput = document.getElementById('num_days');
                const daysContainer = document.getElementById('days-container');

                function generateDays() {
                    const numDays = parseInt(numDaysInput.value) || 1;
                    daysContainer.innerHTML = '';

                    for (let i = 1; i <= numDays; i++) {
                        const dayCard = document.createElement('div');
                        dayCard.className = 'day-card';
                        dayCard.innerHTML = `
                            <div class="day-header">
                                <i class="bi bi-calendar3"></i> Day ${i}
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Date</label>
                                <input type="date" class="form-control" name="day_${i}_date" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Activities/Notes (Optional)</label>
                                <textarea class="form-control" name="day_${i}_notes" rows="3" placeholder="E.g., Visit museum, lunch at downtown, etc."></textarea>
                            </div>
                        `;
                        daysContainer.appendChild(dayCard);
                    }
                }

                // Generate days on page load
                generateDays();

                // Regenerate days when number changes
                numDaysInput.addEventListener('change', generateDays);
                numDaysInput.addEventListener('input', generateDays);

                // Form submission validation
                const form = document.querySelector('form[method="post"]');
                
                if (form) {
                    form.addEventListener('submit', function(e) {
                        console.log('Form submission triggered');
                        
                        // Check if hidden fields have values
                        const placeId = document.getElementById('id_place_id').value;
                        const lat = document.getElementById('id_lat').value;
                        const lng = document.getElementById('id_lng').value;
                        
                        console.log('Place ID:', placeId);
                        console.log('Latitude:', lat);
                        console.log('Longitude:', lng);
                        
                        // Check for validation errors
                        const invalidFields = form.querySelectorAll(':invalid');
                        if (invalidFields.length > 0) {
                            console.log('Invalid fields:', invalidFields);
                            invalidFields.forEach(field => {
                                console.log('- Invalid field:', field.name || field.id, field.validationMessage);
                            });
                        }
                        
                        // If location field is empty, prevent submission
                        const locationInput = document.getElementById('id_destination');
                        if (!locationInput.value.trim()) {
                            e.preventDefault();
                            alert('Please enter a location');
                            return false;
                        }
                        
                        // If hidden fields are empty, warn user
                        if (!placeId || !lat || !lng) {
                            console.warn('Warning: Location coordinates not captured. Make sure to select from dropdown.');
                        }
                    });
                }
            });
        </script>
        
        
    </body>
</html>