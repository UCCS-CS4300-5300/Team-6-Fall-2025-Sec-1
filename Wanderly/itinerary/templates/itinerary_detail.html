{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <title>Itinerary Details</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{% static 'navbar.css' %}">
    <link rel="stylesheet" href="{% static 'itinerary/styles.css' %}">
</head>

    <body>
        {% include "navbar.html" %}
        <div class="container my-5">
            <div class="row justify-content-center">
                <div class="col-lg-9">
                    <div class="itinerary-header">
                        <h2><i class="bi bi-calendar-check"></i> Itinerary for {{ itinerary.destination }}</h2>
                        <h2><i class="bi bi-calendar-check"></i> Access Code: {{ itinerary.access_code }}</h2>
                        <p class="header-subtitle">
                            AI-crafted plan for {{ itinerary.num_days }} day{{ itinerary.num_days|pluralize }}
                        </p>
                        <div class="row g-3 mt-3">
                            <div class="col-md-4">
                                <div class="mini-stat">
                                    <p class="text-muted mb-1">Dates</p>
                                    <p class="mb-0 fw-semibold">
                                        {{ itinerary.start_date|date:"M d, Y" }} – {{ itinerary.end_date|date:"M d, Y" }}
                                    </p>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mini-stat">
                                    <p class="text-muted mb-1">Trip Style</p>
                                    <p class="mb-0 fw-semibold">{{ itinerary.get_trip_purpose_display }}</p>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mini-stat">
                                    <p class="text-muted mb-1">Travelers</p>
                                    <p class="mb-0 fw-semibold">
                                        {{ itinerary.party_adults }} adult{{ itinerary.party_adults|pluralize }}
                                        {% if itinerary.party_children %}
                                            &amp; {{ itinerary.party_children }} child{{ itinerary.party_children|pluralize }}
                                        {% endif %}
                                    </p>
                                </div>
                            </div>
                        </div>
                        {% if itinerary.arrival_datetime or itinerary.departure_datetime %}
                        <div class="row g-3 mt-2">
                            {% if itinerary.arrival_datetime %}
                            <div class="col-md-6">
                                <div class="mini-stat border-top pt-2">
                                    <p class="text-muted mb-1">Arrival Flight</p>
                                    <p class="mb-0 fw-semibold">
                                        {{ itinerary.arrival_datetime|date:"M d, Y @ h:i A" }}
                                        {% if itinerary.arrival_airport %}via {{ itinerary.arrival_airport }}{% endif %}
                                    </p>
                                    {% if itinerary.arrival_airline or itinerary.arrival_flight_number %}
                                    <p class="text-muted mb-0 small">
                                        {% if itinerary.arrival_airline %}{{ itinerary.arrival_airline }}{% endif %}
                                        {% if itinerary.arrival_airline and itinerary.arrival_flight_number %}, {% endif %}
                                        {% if itinerary.arrival_flight_number %}Flight {{ itinerary.arrival_flight_number }}{% endif %}
                                    </p>
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}
                            {% if itinerary.departure_datetime %}
                            <div class="col-md-6">
                                <div class="mini-stat border-top pt-2">
                                    <p class="text-muted mb-1">Departure Flight</p>
                                    <p class="mb-0 fw-semibold">
                                        {{ itinerary.departure_datetime|date:"M d, Y @ h:i A" }}
                                        {% if itinerary.departure_airport %}from {{ itinerary.departure_airport }}{% endif %}
                                    </p>
                                    {% if itinerary.departure_airline or itinerary.departure_flight_number %}
                                    <p class="text-muted mb-0 small">
                                        {% if itinerary.departure_airline %}{{ itinerary.departure_airline }}{% endif %}
                                        {% if itinerary.departure_airline and itinerary.departure_flight_number %}, {% endif %}
                                        {% if itinerary.departure_flight_number %}Flight {{ itinerary.departure_flight_number }}{% endif %}
                                    </p>
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        {% else %}
                        <div class="row g-3 mt-2">
                            <div class="col-12">
                                <div class="mini-stat border-top pt-2">
                                    <p class="text-muted mb-1">Flights</p>
                                    <p class="mb-0">No flight information provided.</p>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <h6 class="text-muted mb-1">Wake Time</h6>
                                <p class="mb-0">{{ itinerary.wake_up_time|time:"g:i A" }}</p>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-muted mb-1">Bed Time</h6>
                                <p class="mb-0">{{ itinerary.bed_time|time:"g:i A" }}</p>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-muted mb-1">Break Times</h6>
                                {% if break_times %}
                                <ul class="mb-0 ps-3">
                                    {% for bt in break_times %}
                                    <li>{{ bt.start_time|time:"g:i A" }} - {{ bt.end_time|time:"g:i A" }}</li>
                                    {% endfor %}
                                </ul>
                                {% else %}
                                <p class="mb-0">None</p>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-muted mb-1">Budget</h6>
                                {% if budget_items %}
                                <ul class="mb-0 ps-3">
                                    {% for item in budget_items %}
                                    <li>
                                        {% if item.category == "Other" and item.custom_category %}
                                        {{ item.custom_category }}
                                        {% else %}
                                        {{ item.category }}
                                        {% endif %}
                                        : ${{ item.amount }}
                                    </li>
                                    {% endfor %}
                                </ul>
                                {% else %}
                                <p class="mb-0">Flexible</p>
                                {% endif %}
                            </div>
                        </div>

                            <div class="row g-3 mt-3">
                                <div class="col-md-6">
                                    <h6 class="text-muted mb-1">Hotel Plans</h6>
                                    {% if itinerary.hotel_name or itinerary.hotel_address or itinerary.hotel_check_in or itinerary.hotel_check_out %}
                                    <ul class="mb-0 ps-3">
                                        {% if itinerary.hotel_name %}
                                        <li>{{ itinerary.hotel_name }}</li>
                                        {% endif %}
                                        {% if itinerary.hotel_address %}
                                        <li>{{ itinerary.hotel_address }}</li>
                                        {% endif %}
                                        {% if itinerary.hotel_check_in %}
                                        <li>Check-in: {{ itinerary.hotel_check_in|date:"M d, Y @ h:i A" }}</li>
                                        {% endif %}
                                        {% if itinerary.hotel_check_out %}
                                        <li>Check-out: {{ itinerary.hotel_check_out|date:"M d, Y @ h:i A" }}</li>
                                        {% endif %}
                                    </ul>
                                    {% else %}
                                    <p class="mb-0">No hotel information provided.</p>
                                    {% endif %}
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-muted mb-1">Dietary &amp; Mobility Notes</h6>
                                    <p class="mb-1">{{ itinerary.dietary_notes|default:"No dietary information provided." }}</p>
                                    <p class="mb-0 text-muted">{{ itinerary.mobility_notes|default:"No mobility information provided." }}</p>
                                </div>
                            </div>

                            {% if day_notes_display %}
                            <hr />
                            <h6 class="text-muted mb-2">Day Notes</h6>
                            <ul class="mb-0 ps-3">
                                {% for entry in day_notes_display %}
                                <li>
                                    Day {{ entry.day_number }} ({{ entry.date }}): {{ entry.text }}
                                </li>
                                {% endfor %}
                            </ul>
                            {% else %}
                            <hr />
                            <h6 class="text-muted mb-2">Day Notes</h6>
                            <p class="mb-0 text-muted">No per-day notes were provided.</p>
                            {% endif %}

                            <div
                                id="generation-status"
                                class="alert alert-info mt-4{% if not is_generating %} d-none{% endif %}"
                                data-is-generating="{{ is_generating|yesno:'true,false' }}"
                                data-status-url="{% url 'itinerary:itinerary_status' itinerary.access_code %}"
                                role="status"
                            >
                                <div class="d-flex flex-column flex-lg-row align-items-lg-center gap-3">
                                    <div>
                                        <h6 class="mb-1 text-info fw-semibold">
                                            Wanderly is refining this itinerary.
                                        </h6>
                                        <p class="mb-0 small text-muted" data-status-text>
                                            This page will refresh automatically once all activities are ready.
                                        </p>
                                    </div>
                                    <div class="progress flex-grow-1 generation-progress" style="min-width: 220px;">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated generation-progress-bar" style="width: 10%;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                {% if accommodation_info %}
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="d-flex align-items-start justify-content-between">
                            <div>
                                <h5 class="mb-2"><i class="bi bi-house-door"></i> Recommended Lodging</h5>
                                <p class="mb-1 fw-semibold">{{ accommodation_info.name }}</p>
                                {% if accommodation_info.address %}
                                <p class="mb-1 text-muted">{{ accommodation_info.address }}</p>
                                {% endif %}
                                {% if accommodation_info.price_per_night %}
                                <span class="badge bg-light text-dark">
                                    <i class="bi bi-cash"></i> {{ accommodation_info.price_per_night }}
                                </span>
                                {% endif %}
                            </div>
                            {% if accommodation_info.notes %}
                            <div class="ms-3 text-muted" style="max-width: 320px;">
                                {{ accommodation_info.notes }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}

                    <section class="itinerary-days-section">
                        {% if ai_itinerary_days %}
                            {% for day in ai_itinerary_days %}
                            <div class="day-itinerary-card" data-day-card data-day-number="{{ day.day_number }}">
                                <div class="day-header">
                                    <div class="day-heading">
                                        <div class="day-badge">Day {{ day.day_number }}</div>
                                        <h3>{{ day.title }}</h3>
                                    </div>
                                </div>
                            {% if day.form_day %}
                            <div class="day-annotations px-3 py-2">
                                <div class="d-flex flex-wrap gap-2">
                                    {% if day.form_day.wake_override or day.form_day.bed_override %}
                                    <span class="meta-badge">
                                        Custom rhythm:
                                        {{ day.form_day.wake_override|default:itinerary.wake_up_time|time:"g:i A" }}
                                        –
                                        {{ day.form_day.bed_override|default:itinerary.bed_time|time:"g:i A" }}
                                    </span>
                                    {% endif %}
                                    {% if day.form_day.must_do %}
                                    <span class="meta-badge badge-mustdo">
                                        <i class="bi bi-star-fill"></i>
                                        Must-do: {{ day.form_day.must_do }}
                                    </span>
                                    {% endif %}
                                </div>
                                {% if day.form_day.constraints %}
                                <p class="text-muted small mb-0 mt-2">
                                    Constraints: {{ day.form_day.constraints }}
                                </p>
                                {% endif %}
                            </div>
                            {% endif %}

                            <div class="activities-list">
                                    {% for activity in day.activities %}
                                    <div class="activity-item"
                                         data-place-query="{{ activity.place_query|default:'' }}"
                                         data-requires-place="{{ activity.requires_place|yesno:'true,false' }}"
                                         data-day-weekday="{% if day.form_day %}{{ day.form_day.date|date:'l' }}{% endif %}">
                                        <div class="activity-time">
                                            <i class="bi bi-clock"></i>
                                            <span>{{ activity.time }}</span>
                                        </div>
                                        <div class="activity-details">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div>
                                                    <h4>{{ activity.name }}</h4>
                                                    <p>{{ activity.description }}</p>
                                                </div>
                                                {% if activity.requires_place %}
                                                <div class="activity-rating badge bg-light text-dark" data-rating>
                                                    <span class="text-muted">Loading...</span>
                                                </div>
                                                {% endif %}
                                            </div>
                                             <div class="activity-meta">
                                                 {% if activity.duration %}
                                                 <span class="meta-badge">
                                                     <i class="bi bi-hourglass-split"></i> {{ activity.duration }}
                                                 </span>
                                                {% endif %}
                                                {% if activity.cost_estimate %}
                                                <span class="meta-badge">
                                                    <i class="bi bi-cash"></i> {{ activity.cost_estimate }}
                                                </span>
                                                {% endif %}
                                             </div>
                                             {% if activity.requires_place %}
                                             <div class="activity-place-details d-none" data-place-details>
                                                 <div class="place-line d-none" data-place-name-line>
                                                     <i class="bi bi-shop"></i>
                                                     <span data-place-name></span>
                                                 </div>
                                                 <div class="place-line d-none" data-place-address-line>
                                                     <i class="bi bi-geo-alt"></i>
                                                     <span data-place-address></span>
                                                 </div>
                                                 <div class="place-line d-none" data-place-hours-line>
                                                     <i class="bi bi-clock-history"></i>
                                                     <span data-place-hours></span>
                                                 </div>
                                             </div>
                                             {% endif %}
                                             {% if activity.requires_place %}
                                             <button type="button" class="btn reviews-btn mt-2" data-review-btn disabled>
                                                 View Reviews
                                             </button>
                                             {% endif %}
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endfor %}
                        {% endif %}
                    </section>

                <div class="itinerary-actions mt-4">
                    <button type="button" class="btn-primary-custom" onclick="window.print()">
                        <i class="bi bi-printer"></i> Print Itinerary
                    </button>
                    <a href="{% url 'itinerary:itinerary' %}" class="btn-secondary-custom">
                        <i class="bi bi-arrow-left"></i> Create Another
                    </a>
                </div>
            </div>
        </div>
    </div>

    <input type="hidden" id="itineraryCsrfToken" value="{{ csrf_token }}">

    <div class="modal fade" id="reviewsModal" tabindex="-1" aria-labelledby="reviewsModalLabel"
        aria-describedby="reviewsModalDescription" aria-hidden="true" role="dialog" aria-modal="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="reviewsModalLabel">Place Reviews</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="reviewsModalDescription" class="visually-hidden">Recent reviews for the selected place</p>
                    <h6 id="reviewsPlaceTitle" class="fw-bold mb-3"></h6>
                    <div id="reviewsList"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="py-4 mt-5">
        <div class="container">
            <div class="row align-items-center gy-3">
                <div class="col-md-6 text-center text-md-start">
                    <span>&copy; 2025 Wanderly. All rights reserved.</span>
                </div>
                <div class="col-md-6">
                </div>
            </div>
        </div>
    </footer>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
        <script>
            (function () {
                const csrfTokenInput = document.getElementById("itineraryCsrfToken");
                const csrfToken = csrfTokenInput ? csrfTokenInput.value : "";
                const generationStatus = document.getElementById("generation-status");
                const reviewsModalEl = document.getElementById("reviewsModal");
                const reviewsModal = new bootstrap.Modal(reviewsModalEl);
                const reviewsPlaceTitle = document.getElementById("reviewsPlaceTitle");
                const reviewsList = document.getElementById("reviewsList");

                function initGenerationStatus() {
                    if (!generationStatus) {
                        return;
                    }
                    const isGenerating = generationStatus.dataset.isGenerating === "true";
                    if (!isGenerating) {
                        generationStatus.classList.add("d-none");
                        return;
                    }
                    generationStatus.classList.remove("d-none");
                    startStatusPolling();
                }

                function startStatusPolling() {
                    const statusUrl = generationStatus.dataset.statusUrl;
                    if (!statusUrl) {
                        return;
                    }
                    const progressBar = generationStatus.querySelector(".generation-progress-bar");
                    const statusText = generationStatus.querySelector("[data-status-text]");
                    let progress = 10;
                    const progressInterval = setInterval(() => {
                        progress = Math.min(95, progress + (Math.random() * 9));
                        if (progressBar) {
                            progressBar.style.width = `${progress}%`;
                        }
                    }, 2200);

                    const poll = () => {
                        fetch(statusUrl, { headers: { Accept: "application/json" } })
                            .then((response) => (response.ok ? response.json() : Promise.reject(new Error("status error"))))
                            .then((data) => {
                                if (data && data.is_generating === false) {
                                    clearInterval(progressInterval);
                                    if (progressBar) {
                                        progressBar.style.width = "100%";
                                    }
                                    if (statusText) {
                                        statusText.textContent = "Wrapping up — refreshing with your final plan…";
                                    }
                                    setTimeout(() => {
                                        window.location.reload();
                                    }, 900);
                                } else {
                                    setTimeout(poll, 4000);
                                }
                            })
                            .catch(() => {
                                setTimeout(poll, 6000);
                            });
                    };
                    poll();
                }

                initGenerationStatus();

                function renderStars(rating) {
                    const stars = [];
                    const fullStars = Math.floor(rating);
                    const hasHalf = rating - fullStars >= 0.5;
                    for (let i = 0; i < 5; i += 1) {
                        if (i < fullStars) {
                            stars.push('<span class="star">&#9733;</span>');
                        } else if (i === fullStars && hasHalf) {
                            stars.push('<span class="star">&#9734;</span>');
                        } else {
                            stars.push('<span class="star text-muted">&#9734;</span>');
                        }
                    }
                    return stars.join("");
                }

                function formatHoursText(data, weekday) {
                    if (!data || typeof data !== "object") {
                        return "";
                    }
                    const hoursArr = Array.isArray(data.hours) ? data.hours : [];
                    if (hoursArr.length) {
                        if (weekday) {
                            const match = hoursArr.find((entry) => entry.toLowerCase().startsWith(weekday.toLowerCase()));
                            if (match) {
                                return match;
                            }
                        }
                        return hoursArr.slice(0, 2).join(" | ");
                    }
                    if (typeof data.open_now === "boolean") {
                        return data.open_now ? "Open now" : "Currently closed";
                    }
                    return data.primary_type || "";
                }

                function setUnavailableState(item, message) {
                    const ratingEl = item.querySelector("[data-rating]");
                    const reviewsButton = item.querySelector("[data-review-btn]");
                    if (ratingEl) {
                        ratingEl.classList.add("d-none");
                        ratingEl.innerHTML = "";
                    }
                    if (reviewsButton) {
                        reviewsButton.disabled = true;
                        reviewsButton.classList.add("d-none");
                        reviewsButton.textContent = message || "No Reviews";
                    }
                }

            function handleReviewsResponse(item, data) {
                if (!item) {
                    return;
                }

                if (!data || typeof data !== "object") {
                    setUnavailableState(item, "Rating unavailable");
                    return;
                }

                    const ratingEl = item.querySelector("[data-rating]");
                    const reviewsButton = item.querySelector("[data-review-btn]");
                    const detailsWrapper = item.querySelector("[data-place-details]");
                    const nameLine = item.querySelector("[data-place-name-line]");
                    const addressLine = item.querySelector("[data-place-address-line]");
                    const hoursLine = item.querySelector("[data-place-hours-line]");
                    const nameTarget = item.querySelector("[data-place-name]");
                    const addressTarget = item.querySelector("[data-place-address]");
                    const hoursTarget = item.querySelector("[data-place-hours]");
                    const weekday = item.dataset.dayWeekday || "";
                    if (!ratingEl) {
                        return;
                    }
                    ratingEl.classList.remove("d-none");

                    const reviews = Array.isArray(data.reviews) ? data.reviews : [];
                    item.dataset.placeName = data.name || item.dataset.placeQuery;
                    if (data.address) {
                        item.dataset.placeAddress = data.address;
                    }
                    item.dataset.reviews = JSON.stringify(reviews);

                    if (!data.rating) {
                        ratingEl.classList.add("d-none");
                        ratingEl.innerHTML = "";
                    } else {
                        const ratingMarkup = `
                            <div>${renderStars(data.rating)}</div>
                            <div class="mt-1 text-dark fw-semibold">${data.rating.toFixed(1)}</div>
                            <div class="text-muted small">${data.count || 0} reviews</div>
                        `;
                        ratingEl.innerHTML = ratingMarkup;
                        ratingEl.classList.remove("d-none");
                    }

                    if (reviewsButton) {
                        if (!reviews.length) {
                            reviewsButton.disabled = true;
                            reviewsButton.classList.add("d-none");
                        } else {
                            reviewsButton.disabled = false;
                            reviewsButton.classList.remove("d-none");
                            reviewsButton.textContent = "View Reviews";
                        }
                    }

                    let showAnyDetail = false;
                    if (detailsWrapper) {
                        if (nameTarget && nameLine) {
                            if (data.name) {
                                nameTarget.textContent = data.name;
                                nameLine.classList.remove("d-none");
                                showAnyDetail = true;
                            } else {
                                nameTarget.textContent = "";
                                nameLine.classList.add("d-none");
                            }
                        }
                        if (addressTarget && addressLine) {
                            if (data.address) {
                                addressTarget.textContent = data.address;
                                addressLine.classList.remove("d-none");
                                showAnyDetail = true;
                            } else {
                                addressTarget.textContent = "";
                                addressLine.classList.add("d-none");
                            }
                        }
                        const hoursText = formatHoursText(data, weekday);
                        if (hoursTarget && hoursLine) {
                            if (hoursText) {
                                hoursTarget.textContent = hoursText;
                                hoursLine.classList.remove("d-none");
                                showAnyDetail = true;
                            } else {
                                hoursTarget.textContent = "";
                                hoursLine.classList.add("d-none");
                            }
                        }
                        detailsWrapper.classList.toggle("d-none", !showAnyDetail);
                    }
                }

                document.querySelectorAll(".activity-item").forEach((item) => {
                    const requiresPlace = item.dataset.requiresPlace !== "false";
                    const query = (item.dataset.placeQuery || '').trim();
                    if (!requiresPlace || !query) {
                        return;
                    }

                fetch("{% url 'itinerary:place_reviews' %}", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": csrfToken,
                    },
                    body: JSON.stringify({ query }),
                })
                    .then((response) => (response.ok ? response.json() : Promise.reject(new Error("Bad response from server"))))
                    .then((data) => handleReviewsResponse(item, data))
                    .catch(() => {
                        setUnavailableState(item, "Unable to load rating");
                    });
            });

            document.querySelectorAll("[data-review-btn]").forEach((button) => {
                button.addEventListener("click", () => {
                    const wrapper = button.closest(".activity-item");
                    if (!wrapper) {
                        return;
                    }
                    const name = wrapper.dataset.placeName || "Recent Reviews";
                    const reviews = JSON.parse(wrapper.dataset.reviews || "[]");

                    reviewsPlaceTitle.textContent = name;
                    if (!reviews.length) {
                        reviewsList.innerHTML = '<p class="text-muted mb-0">No reviews available.</p>';
                    } else {
                        reviewsList.innerHTML = reviews
                            .slice(0, 6)
                            .map((review) => `
                                    <div class="mb-3 border-bottom pb-2">
                                        <div class="d-flex justify-content-between">
                                            <strong>${review.author || "Traveler"}</strong>
                                            <span>${renderStars(review.rating || 0)}</span>
                                        </div>
                                        <p class="mb-0 mt-2">${review.text || "No review text provided."}</p>
                                    </div>
                                `)
                                .join("");
                        }
                        reviewsModal.show();
                    });
                });

            })();
        </script>
    </body>
</html>