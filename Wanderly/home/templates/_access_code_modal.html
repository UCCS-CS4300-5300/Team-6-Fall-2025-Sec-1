<div class="modal fade" id="accessCodeModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content access-code-modal">
        {# TODO (Next Sprint): change method to POST and add action to itinerary access view #}
      <form id="accessCodeForm" method="post" action="{% url 'itinerary:find_itinerary' %}">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title">Access itinerary</h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>

        <div class="modal-body">
          <label for="accessCodeInput" class="form-label">Access code</label>
          <input
            type="text"
            class="form-control"
            id="accessCodeInput"
            name="access_code"
            placeholder="Enter your itinerary code"
            required
          >
          <small class="text-muted">
            In the next sprint we are connecting this to itineraries.
          </small>
          <div id="accessCodeMessage" class="mt-2 small"></div>
        </div>

        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">View itinerary</button>
        </div>
      </form>
    </div>
  </div>
</div>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const form = document.getElementById("accessCodeForm");
    if (!form) return;
  
    const input = document.getElementById("accessCodeInput");
    const messageDiv = document.getElementById("accessCodeMessage");
  
    form.addEventListener("submit", async function (e) {
      e.preventDefault();  // stop normal form submit / page reload
  
      messageDiv.textContent = "";
      messageDiv.classList.remove("text-danger");
  
      const accessCode = input.value.trim();
      if (!accessCode) {
        messageDiv.textContent = "Please enter an access code.";
        messageDiv.classList.add("text-danger");
        return;
      }
  
      const csrfToken = form.querySelector("input[name='csrfmiddlewaretoken']").value;
  
      try {
        const response = await fetch(form.action, {
          method: "POST",
          headers: {
            "X-Requested-With": "XMLHttpRequest",
            "X-CSRFToken": csrfToken,
            "Content-Type": "application/x-www-form-urlencoded",
          },
          body: new URLSearchParams({ access_code: accessCode }),
        });
  
        const data = await response.json();
  
        if (data.ok) {
          // Success: go to the detail page
          window.location.href = data.redirect_url;
        } else {
          messageDiv.textContent = data.error || "Something went wrong.";
          messageDiv.classList.add("text-danger");
        }
      } catch (err) {
        console.error(err);
        messageDiv.textContent = "Network error. Please try again.";
        messageDiv.classList.add("text-danger");
      }
    });
  });
  </script>
  